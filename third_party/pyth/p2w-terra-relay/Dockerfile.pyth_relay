FROM node:16-alpine

ARG P2W_BASE_PATH=/usr/src/pyth2wormhole

RUN apk --no-cache --update add python3 build-base  # Needed by the Ethereum build

WORKDIR ${P2W_BASE_PATH}/ethereum
ADD ethereum .
RUN npm ci && npm run build

RUN apk del build-base # No longer needed after EVM build

ARG P2W_RELAY_REL_PATH=third_party/pyth/p2w-terra-relay

WORKDIR ${P2W_BASE_PATH}/${P2W_RELAY_REL_PATH} 
ADD ${P2W_RELAY_REL_PATH} .

RUN npm install && npm run build && npm cache clean --force

# If you are building for production
# RUN npm ci --only=production

RUN mkdir -p /app/pyth_relay/logs
RUN addgroup -S pyth -g 10001 && adduser -S pyth -G pyth -u 10001
RUN chown -R pyth:pyth .
USER pyth

CMD [ "node", "lib/index.js" ]
